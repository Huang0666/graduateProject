# 汽车评论情感分析模型训练流程

## 一、训练概述

本项目采用多阶段训练策略，通过不同的数据采样和处理方式逐步提升模型性能：
1. 第一次训练：基础版本（1000条均衡数据）
2. 第二次训练：考虑评论质量的中等规模数据（3000条）
3. 第三次训练：保持原始分布的全量数据（6015条）
4. 第四次训练：大规模数据训练（30000条）

## 二、训练流程详解

### 1. 数据处理策略对比

| 版本 | 数据量 | 采样策略 | 类别分布 | 特殊处理 | 训练集 | 验证集 | 训练时长 |
|-----|--------|----------|----------|----------|---------|---------|----------|
| V1  | 1000   | 随机采样 | 强制均衡 | 无 | 800 | 200 | 2h |
| V2  | 3000   | 加权采样 | 强制均衡 | 考虑点赞和回复数 | 2400 | 600 | 4h |
| V3  | 6015   | 全量使用 | 保持原始 | 保持类别分布一致 | 4800 | 1200 | 8h |
| V4  | 30000  | 全量使用 | 保持原始 | 四分类直接训练 | 21109 | 5956 | 12h |

### 2. 训练参数配置对比

| 版本 | batch_size | learning_rate | epochs | warmup_ratio | weight_decay | 继承模型 |
|-----|------------|---------------|---------|--------------|--------------|----------|
| V1  | 16 | 2e-5 | 15 | 0.15 | 0.02 | 无 |
| V2  | 32 | 1e-5 | 25 | 0.20 | 0.03 | V1 best |
| V3  | 64 | 5e-6 | 40 | 0.25 | 0.04 | V2 best |
| V4  | 64 | 5e-6 | 15 | 0.10 | 0.01 | V3 best |

### 3. 各版本训练详解

#### 3.1 V1版本（基准训练）

- 数据准备：
  - 1000条数据，随机均衡采样
  - 四类各250条
- 训练集:验证集 = 8:2

- 训练配置：
```python
{
    'batch_size': 16,
    'learning_rate': 2e-5,
    'epochs': 15,
    'warmup_ratio': 0.15,
    'weight_decay': 0.02
}
```

- 执行命令：
```bash
python src/model_process/model_train.py --version v1
```

#### 3.2 V2版本（质量感知）

- 数据准备：
  - 3000条数据，质量加权采样
  - 计算权重：weight = 1 + log(1 + 点赞数) + log(1 + 回复数)
- 优先采样高质量评论

- 训练配置：
```python
{
    'batch_size': 32,
    'learning_rate': 1e-5,
    'epochs': 25,
    'warmup_ratio': 0.2,
    'weight_decay': 0.03,
    'previous_model_path': 'src/saved_models/checkpoints/v1/best_model.pth'
}
```

#### 3.3 V3版本（全量训练）

- 数据准备：
  - 6015条全量数据
- 保持原始类别分布
  - 训练集和验证集保持相同分布比例

- 训练配置：
```python
{
    'batch_size': 64,
    'learning_rate': 5e-6,
    'epochs': 40,
    'warmup_ratio': 0.25,
    'weight_decay': 0.04,
    'previous_model_path': 'src/saved_models/checkpoints/v2/best_model.pth'
}
```

#### 3.4 V4版本（大规模训练）

- 数据准备：
  - 30000条数据
  - 保持原始分布
- 训练集:验证集:测试集 = 7:2:1
  - 增强数据质量控制

- 训练配置：
```python
{
    'batch_size': 64,
    'learning_rate': 5e-6,
    'epochs': 15,
    'warmup_ratio': 0.1,
    'weight_decay': 0.01,
    'gradient_accumulation_steps': 1,
    'previous_model_path': 'src/saved_models/checkpoints/v3/best_model.pth'
}
```

## 三、训练过程监控

### 1. 性能指标监控

1. 损失函数变化：
   - 训练损失：从0.95降至0.4
   - 验证损失：从0.85降至0.4
   - 收敛良好，无明显过拟合

2. 准确率变化：
   - 训练准确率：稳步提升
   - 验证准确率：最终达到约0.83
   - F1分数：从0.69提升到0.84

### 2. 资源使用监控

1. GPU利用率：
   - 基本维持在95-100%
   - 训练过程稳定

2. 内存使用：
   - 峰值使用率：85%
   - 无内存泄漏

## 四、实验结果分析

### 1. 性能提升对比

| 版本 | 准确率 | 加权F1 | 主要改进 |
|-----|--------|--------|----------|
| V1  | 63.26% | 62.58% | 基础性能 |
| V2  | 67.75% | 63.15% | 质量感知 |
| V3  | 71.43% | 68.74% | 分布适应 |
| V4  | 86.20% | 84.50% | 大规模训练 |

### 2. 输出文件结构

```
src/saved_models/
├── checkpoints/              # 模型检查点
│   ├── v1/                  # V1版本检查点
│   ├── v2/                  # V2版本检查点
│   ├── v3/                  # V3版本检查点
│   └── v4/                  # V4版本检查点
├── logs/                    # 训练日志
│   └── v4/                 
│       ├── f1_roc_auc.png      # F1和ROC曲线
│       ├── loss_accuracy.png   # 损失和准确率曲线
│       ├── lr_grad_norm.png    # 学习率和梯度范数
│       ├── precision.png       # 精确率曲线
│       ├── recall.png         # 召回率曲线
│       ├── resource_usage.png # 资源使用情况
│       └── training_log.txt   # 训练日志文件
└── predictions/             # 预测结果
    └── v4/                 # V4预测结果
        ├── evaluation_report.txt
        ├── confusion_matrix.png
        └── error_analysis.txt
```

## 五、注意事项

### 1. 数据处理
- 保持数据格式一致
- 确保类别平衡
- 记录数据来源

### 2. 模型保存
- 每个版本保存最佳模型
- 记录模型保存路径
- 备份重要检查点

### 3. 实验记录
- 详细记录配置参数
- 保存训练日志
- 记录改进效果

### 4. 错误分析
- 记录典型错误案例
- 分析错误原因
- 提出改进方向

## 六、部署建议

### 1. 模型选择
- 推荐使用V4版本模型
- 根据实际需求可选择其他版本
- 可根据资源情况调整batch_size

### 2. 资源需求
- GPU内存：>= 8GB
- CPU内存：>= 16GB
- 存储空间：>= 10GB

### 3. 性能优化
- 使用混合精度训练
- 根据GPU显存调整batch_size
- 优化数据加载流程
